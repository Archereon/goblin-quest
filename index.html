<!DOCTYPE HTML>
<!--
	Indivisible by Pixelarity
	pixelarity.com | hello@pixelarity.com
	License: pixelarity.com/license
	
This is an RPG about goblins going on a quest. The quest is divided into 9 pre-defined stages. 
Each stage has a certain amount of "health". 
Once the stage reaches zero hit points, the players win and move on to the next stage. 
At the end of the 9th stage, if there are still goblins, the goblins win! 
If all goblins die, they lose! 

When a goblin takes an action, they roll a 6-sided die.

If they roll: 
6 - Great success! Subtract 2 from the stage health
5 - Success! Subtract 1 from the stage health
4 - Something good! The next player can roll an extra die (advantage)
3 - Nothing
2 - Something bad! The next player gets -1 to their first roll (disadvantage)
1 - INSTANT DEATH! Your Goblin dies and your turn ends. 

A player can choose to roll the die again for each extertise, heirloom, feature, or dream they use in their action. 

Each player controls 5 goblins. They all have the same extertise, heirloom, feature, and dream. However, those traits are randomly assigned to all of their goblins once they connect. 

The backend is 2 different lambda URLs with a dynamodb keeping the game state. 
One lambda URL is for pushing actions to. The other one is simply to periodically retrieve the game data. 
On a player's turn, they submit some action (either text or a roll). 
We display that text (as well as all previously submitted text) in a text box on the screen. 
After their action, they receive how many rolls they are allowed from the backend. 
Then they can submit rolls, one at a time, or end their turn. 
Then we display the results of the roll on the screen. 
Once all the dice rolls are done, or the player ends their turn, the player must narrate what happened. 
Then the games waits for the player to submit more text, narrating what happened. 


These are the actions a player can send into the backend:
connect
    Just a request for connection with their player_id
describe
    Text
roll
    True if they want to roll again, False if they want to stop. They need to roll at least once. 
-->
<html lang="en">
    <head>
        <title>Goblin Quest</title>
        <meta name="keywords" content="goblins" />
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
        <link rel="stylesheet" href="assets/css/main.css" />
        <noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap">
    </head>
    <body class="is-preload-0 is-preload-1">
        <!-- Wrapper -->
        <div id="wrapper">
            <!-- Dice Box (3D Dice Roller) -->
            <div id="dice-box"></div>

            <!-- Room Connect Panel -->
            <article id="RoomConnect" class="panel special">
                <section>
                    <header>
                        <h3>Gather your goblins!</h3>
                    </header>
                    <div id="roomInput">
                        <input type="text" id="room_id" placeholder="Enter Room">
                    </div>
                    <div id="playerIDInput">
                        <input type="text" id="player_id" placeholder="Enter Name">
                    </div>
                    <ul class="actions special" style="margin-top: 1em;">
                        <li><a class="button" id="Connect">Connect</a></li>
                        <li><a class="button" id="CreateRoom">Create Room</a></li>
                    </ul>
                    <div id="RoomStatus"></div>
                </section>
            </article>

            <!-- Room Setup Panel -->
            <article id="RoomSetup" class="panel special">
                <section style="display: flex; flex-direction: row; justify-content: space-around; gap: 2em;">
                    <!-- Left side: Game Speed & Text Boxes -->
                    <div>   
                        <h3>Game Speed</h3>
                        <!-- Normal speed -->
                        <input type="radio" id="gameSpeedNormal" name="gameSpeed" value="normal" checked>
                        <label for="gameSpeedNormal">Normal</label>

                        <!-- Fast speed -->
                        <input type="radio" id="gameSpeedFast" name="gameSpeed" value="fast">
                        <label for="gameSpeedFast">Fast</label>

                        <div id="textBoxSection" style="margin-top: 1em;">
                            <!-- These text boxes will be dynamically populated via JavaScript -->
                        </div>
						<!-- Start Game Button -->
                        <div style="margin-top: 1em;">
                            <a class="button" id="defaultStoryButton">Use Default Story</a>
                            <a class="button" id="startGameButton">Start Game!</a>
                        </div>
                    </div>

                    <!-- Right side: Connected Players -->
                    <div>
                        <h3>Players Connected</h3>
                        <ul id="connectedPlayers" style="list-style-type: none; padding-left: 0;">
                            <!-- Populated dynamically with player IDs -->
                        </ul>
                    </div>
                </section>
            </article>

            <!-- Main Room Panel -->
            <article id="MainRoom" class="panel special"
                style="
                    display: flex; 
                    flex-direction: row; 
                    gap: 1em; 
                    justify-content: space-between;
                    align-items: flex-start;
                    padding: 1em;
                "
            >
                <!-- LEFT COLUMN -->
                <div id="left-column" style="flex: 1; display: flex; flex-direction: column; gap: 1em;">
                    <!-- Stage Health -->
                    <div>
                        <h3>Stage Health</h3>
                        <img 
                            id="stageHealthImage" 
                            src="images/heart_100_percent.png" 
                            alt="Stage Health" 
                            style="max-width: 150px; height: auto;"
                        />
                    </div>

                    <!-- Player Data Table (vertical orientation) -->
                    <div>
                        <h3>Your Goblin</h3>
                        <table 
                            id="playerDataTable" 
                            style="
                                margin: 0 auto; 
                                border: 1px solid #ccc; 
                                border-collapse: collapse;
                            "
                        >
                            <tbody id="playerDataTableBody">
                                <!-- Will be dynamically populated in JS -->
                            </tbody>
                        </table>
                        <!-- Goblin image (256x256) -->
                        <div style="text-align: center; margin-top: 1em;">
                            <img 
                                id="playerGoblinImage" 
                                src="images/dead_goblin.png" 
                                alt="Goblin Image" 
                                style="width: 256px; height: 256px;"
                            />
                        </div>
                    </div>
                </div>

                <!-- MIDDLE COLUMN -->
                <div 
                    id="middle-column" 
                    style="
                        flex: 2; 
                        display: flex; 
                        flex-direction: column;
                        gap: 1em;
                    "
                >
                    <!-- Game Story -->
                    <div style="flex: 1; display: flex; flex-direction: column;">
                        <h3>Game Story</h3>
                        <!-- Stage Label -->
                        <div 
                            id="stageLabelContainer" 
                            style="
                                border: 1px solid #ccc; 
                                padding: 0.5em; 
                                background-color: #2f3021; 
                                color: #ececec;
                                text-align: center; 
                                font-weight: bold;
                                font-size: 30px;
                            "
                        >
                            <span id="stageLabel">Stage: ???</span>
                        </div>
                        <div 
                            id="gameStory"
                            style="
                                border: 1px solid #ccc;
                                overflow-y: auto;
                                padding: 1em;
                                background-color: #2f3021; 
                                color: #ececec;   
                                border: 2px dashed #4f4c2a;
                                height: calc(100vh - 400px);
                            "
                        ></div>

                        <!-- Actions (input, roll, end turn, etc.) -->
                        <div 
                            class="actions" 
                            style="
                                display: flex; 
                                flex-direction: column; 
                                border: 1px solid #ccc;
                                padding: 1em;
                                background-color: #2f3021;
                            "
                        >
                            <input type="text" id="descriptionInput" maxlength="200" placeholder="Describe something..." />
                            <ul class="actions special" style="margin-top: 1em;">
                                <li><a class="button" id="submitTextButton">Tell The Tale!</a></li>
                            </ul>
                            <div id="instructionsBox" style="margin-top: 0.5em; font-weight: bold;">
                                Hello
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN -->
                <div id="right-column" style="flex: 1; display: flex; flex-direction: column;">
                    <h3>Goblin Gossip</h3>
                    <div 
                        id="gameLog" 
                        style="
                            border: 1px solid #ccc;
                            overflow-y: auto;
                            padding: 1em;
                            background-color: #2f3021; 
                            color: #ececec;   
                            border: 2px dashed #4f4c2a;
                            height: calc(100vh - 400px);
                        "
                    ></div>
                </div>
            </article>
        </div><!-- End of #wrapper -->

        <!-- Scripts -->
        <!-- Dice Box Setup (3D dice roller) -->
        <script type="module">
		  //////////////////////////////////////////////////
		  // SET UP DICE BOX
		  //////////////////////////////////////////////////
            const pushLambdaUrl = 'https://6jcpwjkgw23nsy5q6zmzigs6va0gyyrv.lambda-url.us-west-1.on.aws/';
            const pullLambdaUrl = 'https://sa3w22e7jvrdd4pjsrnrmvs3re0ytesc.lambda-url.us-west-1.on.aws/';
            import DiceBox from "./dist/dice-box.es.min.js";
          
            // Create a global "Box" so that other scripts can see it:
            window.Box = new DiceBox({
                assetPath: "assets/",
                origin: "https://unpkg.com/@3d-dice/dice-box@1.1.4/dist/",
                theme: "default",
                themeColor: "#feea03",
                offscreen: true,
                scale: 5,
                container: '#dice-box',
                canvasWidth: 500,
                canvasHeight: 500
            });

            window.Box.init().then(() => {
                // Safe to call Box.roll() from here on...
            });

            // Callback when roll completes
            window.Box.onRollComplete = function(roll_result) {
                const storedRoomID = document.getElementById('room_id').value.toUpperCase();
                const storedPlayerID = document.getElementById('player_id').value.toUpperCase();

                // Post the result to your Lambda
                fetch(pushLambdaUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        "action_type": "roll",
                        "room_id": storedRoomID,
                        "player_id": storedPlayerID,
                        "data": roll_result
                    }),
                })
                .then(r => r.json())
                .then(data => console.log('Dice roll posted:', data))
                .catch(err => console.error('Error:', err));
            };
        </script>

        <!-- jQuery / Utility Scripts -->
        <script src="assets/js/jquery.min.js"></script>
        <script src="assets/js/browser.min.js"></script>
        <script src="assets/js/breakpoints.min.js"></script>
        <script src="assets/js/util.js"></script>
        <script src="assets/js/main.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/web-animations-js@2.3.2/web-animations.min.js"></script>

        <!-- Main Game Script -->
        <script>
            const DEFAULTPROMPTSNORMAL = ["You are goblins that live in a goblin camp. You are largely left to your own devices until there is a battle that the orcs and wizards send you into as cannon fodder. One day, you all decide to investigate the mysteries of a nearby pool of slime that is guarded by bears. To do this, you decide you need to steal a prize winning bear, use its body to create a bear suit, and then use the bear suit to investigate the pool of slime.",
                                            "Infiltrate the Bear Show without being seen.",
                                            "Find the prize winning bear.",
                                            "Abscond with the bear.",
                                            "Somehow kill a fully-grown bear, and a prize-winning one at that.",
                                            "Turn the bear into a functional bearsuit.",
                                            "Teach yourselves how to operate the bearsuit.",
                                            "Infiltrate bear society.",
                                            "Defeat the bear guardian of the goop pool.",
                                            "Discover the secret of the slimy pool, and live to tell the tale!"]
            const DEFAULTPROMPTSFAST = ["You are goblins that live in a goblin camp. You are largely left to your own devices until there is a battle that the orcs and wizards send you into as cannon fodder. One day, you all decide to investigate the mysteries of a nearby pool of slime that is guarded by bears. To do this, you decide you need to steal a prize winning bear, use its body to create a bear suit, and then use the bear suit to investigate the pool of slime.",
                                        "Infiltrate the Bear Show without being seen.",
                                        "Abscond with the bear.",
                                        "Somehow kill a fully-grown bear, and a prize-winning one at that.",
                                        "Turn the bear into a functional bearsuit.",
                                        "Infiltrate bear society to discover the secret of the slimy pool, and live to tell the tale!"]
            const pushLambdaUrl = 'https://6jcpwjkgw23nsy5q6zmzigs6va0gyyrv.lambda-url.us-west-1.on.aws/';
            const pullLambdaUrl = 'https://sa3w22e7jvrdd4pjsrnrmvs3re0ytesc.lambda-url.us-west-1.on.aws/';
            
            // Track first fetch
            let firstSuccessfulFetch = true;
            let roll_seed = 0;

            /////////////////////////////////////////////////////
            // POLLING: Fetch Player Update
            /////////////////////////////////////////////////////
            function fetchPlayerUpdate(room_id, player_id) {
                fetch(`${pullLambdaUrl}?room_id=${room_id}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
						// 'data' contains the state of the game. Here is an example of what it looks like:
						//{  
						//  'room_id': 'ABCD',
						//  'player_data':
						//    {player_id_1: 
						//      {
						//       "health": 5,
						//       "expertise": "Sharpshooter",
						//       "heirloom": "Grandma's Spoon",
						//       "feature": "Scar on left eye",
						//       "dream": "Find the lost treasure"
						//      },
						//     player_id_2:
						//      {
						//       "health": 5,
						//       "expertise": "Sharpshooter",
						//       "heirloom": "Grandma's Spoon",
						//       "feature": "Scar on left eye",
						//       "dream": "Find the lost treasure",
						//       "image": "image_url"
						//      },
						//    },
						//    'modifier': 'NONE',
						//    'stage_health': 5,
						// 	  'stage_max_health': 5,
						//    'number_of_rolls_remaining': 0,
						//    'turn_order': [player_id_1, player_id_2],
						//    'current_turn_index': 0,
						//    'game_state': 'WAITING_FOR_NEXT_ACTION',
						//    'game_stage': 1,
						//    'roll_seed': 1,
						//    'game_log': ['lots of text here', 'lots of text here'],
						//    'game_story': ['lots of text here too', 'even more text here'],
						//    'turn_results': ['something good', 'goblin died'],
						//    'prompts': ['prompt 1', 'prompt 2', 'etc']
						//}

						// Update all the screens
												
                        // If we succeed first time, move to #MainRoom
                        if (data.player_data && data.player_data[player_id] && firstSuccessfulFetch) {
                            window.location.href = "#MainRoom"; 
                            firstSuccessfulFetch = false;
                        }

                        // 1. Update player's data table
                        updatePlayerDataTable(data, player_id);

                        // 2. Update stage health
                        updateStageHealth(data);

                        // 3. Update game log
                        if (data.game_log) {
                            const gameLogContainer = document.getElementById('gameLog');
                            gameLogContainer.innerText = data.game_log.join('\n\n');
                            gameLogContainer.scrollTop = gameLogContainer.scrollHeight;
                        }

                        // 4. Update game story
                        if (data.game_story) {
                            const gameStoryContainer = document.getElementById('gameStory');
                            gameStoryContainer.innerText = data.game_story.join('\n\n');
                            gameStoryContainer.scrollTop = gameStoryContainer.scrollHeight;
                        }

                        // 5. Update stage label
                        updateStageLabel(data);

                        // 6. Show or hide action buttons
                        updateActionButtons(data, player_id);

                        // 7. Check for new dice roll (roll_seed)
                        handleNewDiceRoll(data);

                        // 8. Update Connected Players (in #connectedPlayers)
                        updateConnectedPlayers(data);
                    })
                    .catch(error => {
                        console.error('No player data to update right now', error);
                    });
            }

            /////////////////////////////////////////////////////
            // CONNECT / CREATE ROOM
            /////////////////////////////////////////////////////
            document.getElementById('Connect').onclick = function() {
                const enteredRoomID = document.getElementById('room_id').value.toUpperCase();
                const enteredPlayerID = document.getElementById('player_id').value.toUpperCase();

                if (!enteredRoomID) {
                    console.error("No room ID provided.");
                    return;
                }
                if (!enteredPlayerID) {
                    console.error("No room ID provided.");
                    return;
                }
                document.getElementById('submitTextButton').style.display='none';
                document.getElementById('CreateRoom').style.display='none';
                document.getElementById('Connect').style.display='none';
                localStorage.setItem('enteredRoomID', enteredRoomID);
                localStorage.setItem('enteredPlayerID', enteredPlayerID);

                const RoomStatus = document.getElementById('RoomStatus');
                RoomStatus.innerHTML = 'Connecting...';

                fetch(pushLambdaUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        "action_type": "connect",
                        "room_id": enteredRoomID,
                        "player_id": enteredPlayerID,
                        "data": "connect"
                    }),
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        console.error('HTTP Error:', response.status, response.statusText);
                        RoomStatus.innerHTML = 'Could not find room.';
                        document.getElementById('CreateRoom').style.display='inline-block';
                        document.getElementById('Connect').style.display='inline-block';
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                })
                .then(data => {
                    // Start polling
                    setInterval(() => fetchPlayerUpdate(enteredRoomID, enteredPlayerID), 1000);
                    RoomStatus.innerHTML = 'Room found! Connecting...';
                    fetchPlayerUpdate(enteredRoomID, enteredPlayerID);

                    // Jump to #MainRoom
                    window.location.href = "#MainRoom"; 
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            };

            document.getElementById('CreateRoom').onclick = function() {
                const enteredRoomID = document.getElementById('room_id').value.toUpperCase();
                const enteredPlayerID = document.getElementById('player_id').value.toUpperCase();
                if (!enteredRoomID) {
                    console.error("No room ID provided.");
                    return;
                }
                if (!enteredPlayerID) {
                    console.error("No room ID provided.");
                    return;
                }
                
                document.getElementById('submitTextButton').style.display='none';
                document.getElementById('CreateRoom').style.display='none';
                document.getElementById('Connect').style.display='none';

                const RoomStatus = document.getElementById('RoomStatus');
                RoomStatus.innerHTML = 'Creating Room....';

                localStorage.setItem('enteredRoomID', enteredRoomID);
                localStorage.setItem('enteredPlayerID', enteredPlayerID);

                fetch(pushLambdaUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        "action_type": "connect",
                        "room_id": enteredRoomID,
                        "player_id": enteredPlayerID,
                        "data": "create"
                    }),
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        console.error('HTTP Error:', response.status, response.statusText);
                        RoomStatus.innerHTML = 'Room already exists. Please choose another name.';
                        document.getElementById('CreateRoom').style.display='inline-block';
                        document.getElementById('Connect').style.display='inline-block';
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                })
                .then(data => {
                    // Start polling
                    firstSuccessfulFetch = false; // Need to set so we don't immediately switch windows
                    setInterval(() => fetchPlayerUpdate(enteredRoomID, enteredPlayerID), 1000);
                    fetchPlayerUpdate(enteredRoomID, enteredPlayerID);

                    // Jump to #RoomSetup
                    window.location.href = "#RoomSetup"; 
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            };

			/////////////////////////////////////////////////////
            // START GAME Button
            /////////////////////////////////////////////////////
            document.getElementById('startGameButton').onclick = function() {
                const enteredRoomID = document.getElementById('room_id').value.toUpperCase();
                const enteredPlayerID = document.getElementById('player_id').value.toUpperCase();

                // 1. Get selected game speed
                const speedRadio = document.querySelector('input[name="gameSpeed"]:checked');
                let rawPrompts;
                if (speedRadio && speedRadio.value === 'fast') {
                    rawPrompts = [
                        document.getElementById('GameSummary').value,
                        document.getElementById('Prompt1').value,
                        document.getElementById('Prompt2').value,
                        document.getElementById('Prompt3').value,
                        document.getElementById('Prompt4').value,
                        document.getElementById('Prompt5').value
                    ];
                } else {
					rawPrompts = [
                        document.getElementById('GameSummary').value,
                        document.getElementById('Prompt1').value,
                        document.getElementById('Prompt2').value,
                        document.getElementById('Prompt3').value,
                        document.getElementById('Prompt4').value,
                        document.getElementById('Prompt5').value,
                        document.getElementById('Prompt6').value,
                        document.getElementById('Prompt7').value,
                        document.getElementById('Prompt8').value,
                        document.getElementById('Prompt9').value,
                    ];
				}

                // 4. Send "start" command to pushLambdaUrl
                fetch(pushLambdaUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        "action_type": "start",
                        "room_id": enteredRoomID,
                        "player_id": enteredPlayerID,
                        "data": rawPrompts
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Game started:', data);
					// Jump to #MainRoom
                    window.location.href = "#MainRoom"; 
                })
                .catch((error) => {
                    console.error('Error starting game:', error);
                });
            };

            /////////////////////////////////////////////////////
            // Submit Text Button
            /////////////////////////////////////////////////////
            document.getElementById('submitTextButton').onclick = function() {
                document.getElementById('submitTextButton').style.display='none';

                const storedRoomID = document.getElementById('room_id').value.toUpperCase();
                const storedPlayerID = document.getElementById('player_id').value.toUpperCase();
                const description = document.getElementById('descriptionInput').value;

                if (storedRoomID) {
                    document.getElementById('descriptionInput').value = '';
                    fetch(pushLambdaUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            "action_type": "describe",
                            "room_id": storedRoomID,
                            "player_id": storedPlayerID,
                            "data": description
                        }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Success:', data);
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
                }
            };

            /////////////////////////////////////////////////////
            // Submit Text Button
            /////////////////////////////////////////////////////
            
            document.getElementById('defaultStoryButton').onclick = function() {
                const speedRadio = document.querySelector('input[name="gameSpeed"]:checked');
                console.log("Using default story for mode "+ speedRadio)
                if (speedRadio && speedRadio.value === 'fast') {
                    document.getElementById('GameSummary').value = DEFAULTPROMPTSFAST[0];
                    document.getElementById('Prompt1').value = DEFAULTPROMPTSFAST[1];
                    document.getElementById('Prompt2').value = DEFAULTPROMPTSFAST[2];
                    document.getElementById('Prompt3').value = DEFAULTPROMPTSFAST[3];
                    document.getElementById('Prompt4').value = DEFAULTPROMPTSFAST[4];
                    document.getElementById('Prompt5').value = DEFAULTPROMPTSFAST[5];
                } else {
                    document.getElementById('GameSummary').value = DEFAULTPROMPTSNORMAL[0];
                    document.getElementById('Prompt1').value = DEFAULTPROMPTSNORMAL[1];
                    document.getElementById('Prompt2').value = DEFAULTPROMPTSNORMAL[2];
                    document.getElementById('Prompt3').value = DEFAULTPROMPTSNORMAL[3];
                    document.getElementById('Prompt4').value = DEFAULTPROMPTSNORMAL[4];
                    document.getElementById('Prompt5').value = DEFAULTPROMPTSNORMAL[5];
                    document.getElementById('Prompt6').value = DEFAULTPROMPTSNORMAL[6];
                    document.getElementById('Prompt7').value = DEFAULTPROMPTSNORMAL[7];
                    document.getElementById('Prompt8').value = DEFAULTPROMPTSNORMAL[8];
                    document.getElementById('Prompt9').value = DEFAULTPROMPTSNORMAL[9];
                }

                
            };

            // Limit description input to 200 chars
            const descriptionInput = document.getElementById('descriptionInput');
            descriptionInput.addEventListener('input', function() {
                if (this.value.length > 200) {
                    this.value = this.value.substring(0, 200);
                }
            });

            /////////////////////////////////////////////////////
            // Utility functions
            /////////////////////////////////////////////////////
            function updatePlayerDataTable(data, player_id) {
                const currentPlayer = data.player_data[player_id];
                if (!currentPlayer) return;

                const tableBody = document.getElementById('playerDataTableBody');
                tableBody.innerHTML = '';

                // Build the Health row with goblins icons (alive or dead)
                const healthRow = document.createElement('tr');
                const healthCellHTML = [];
                for (let i = 0; i < currentPlayer.max_health; i++) {
                    if (i < currentPlayer.health) {
						// Goblin is alive
                        healthCellHTML.push(`
                            <img 
                                src="images/alive_goblin.png" 
                                alt="Alive Goblin" 
                                style="width:24px; vertical-align:middle; margin-right:4px;"
                            />
                        `);
                    } else {
						// Goblin is dead
                        healthCellHTML.push(`
                            <img 
                                src="images/dead_goblin.png" 
                                alt="Dead Goblin" 
                                style="width:24px; vertical-align:middle; margin-right:4px;"
                            />
                        `);
                    }
                }
                healthRow.innerHTML = `
                    <th style="padding: 0.5em;">Health</th>
                    <td style="padding: 0.5em;">${healthCellHTML.join('')}</td>
                `;
                tableBody.appendChild(healthRow);

                // Build and append Expertise, Heirloom, Feature, Dream
                const rows = [
                    { label: "Expertise", value: currentPlayer.expertise },
                    { label: "Heirloom",  value: currentPlayer.heirloom },
                    { label: "Feature",   value: currentPlayer.feature },
                    { label: "Dream",     value: currentPlayer.dream },
                ];
                rows.forEach(rowData => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <th style="padding: 0.5em;">${rowData.label}</th>
                        <td style="padding: 0.5em;">${rowData.value}</td>
                    `;
                    tableBody.appendChild(row);
                });

                // Update Goblin image if provided
                if (currentPlayer.image) {
                    document.getElementById('playerGoblinImage').src = currentPlayer.image;
                }
            }

			// =================================
			// Update the Stage Health Image
			// =================================
            function updateStageHealth(data) {
                if (typeof data.stage_health === 'number' && typeof data.stage_max_health === 'number') {
                    const ratio = data.stage_health / data.stage_max_health;
                    let heartImageName = '';
                    if (ratio <= 0) {
                        heartImageName = 'heart_0_percent.png';
                    } else if (ratio <= 0.25) {
                        heartImageName = 'heart_25_percent.png';
                    } else if (ratio <= 0.50) {
                        heartImageName = 'heart_50_percent.png';
                    } else if (ratio <= 0.75) {
                        heartImageName = 'heart_75_percent.png';
                    } else {
                        heartImageName = 'heart_100_percent.png';
                    }
                    document.getElementById('stageHealthImage').src = `images/${heartImageName}`;
                }
            }

            function updateStageLabel(data) {
                if (data.prompts && typeof data.game_stage !== 'undefined') {
                    const stageLabel = document.getElementById('stageLabel');
					// Ensure we have a prompt for this game_stage
                    if (data.prompts[data.game_stage]) {
                        stageLabel.textContent = `Current Goal: ${data.prompts[data.game_stage]}`;
                    } else {
                        stageLabel.textContent = `Current Goal: Unknown`;
                    }
                }
            }

            function updateActionButtons(data, player_id) {
                const submitTextButton = document.getElementById('submitTextButton');
                const instructionsBox = document.getElementById('instructionsBox');

                if (data.turn_order && data.turn_order[data.current_turn_index] === player_id) {
                    if (data.game_state === 'WAITING_FOR_ACTION_TEXT') {
                        submitTextButton.style.display = 'inline-block';
                        instructionsBox.textContent = 'Your turn! Write what you want to do.';
                    }
                    else if (data.game_state === 'WAITING_FOR_POST_ROLL_NARRATION') {
                        submitTextButton.style.display = 'inline-block';
                        instructionsBox.textContent = 'Your turn is over! Narrate what happened! ' +
                            'As a reminder: ' + data.turn_results.join(", ");
                    }
                    else if (data.game_state === 'PROCESSING') {
                        submitTextButton.style.display = 'none';
                        instructionsBox.textContent = 'Processing previous turn....';
                    }
                    else {
                        submitTextButton.style.display = 'none';
                    }
                } else {
                    submitTextButton.style.display = 'none';
                    if (data.turn_order) {
                        instructionsBox.textContent = "Waiting for other player's turn: " + data.turn_order[data.current_turn_index];
                    } else {
                        instructionsBox.textContent = "Waiting for another player...";
                    }
                }
            }

            function handleNewDiceRoll(data) {
                if (roll_seed != data.roll_seed) {
                    console.log("There was a new roll_seed detected!");
                    console.log(data.number_of_rolls_remaining.toString() + "d6");
                    console.log(data.roll_seed);
                    roll_seed = data.roll_seed;

                    Box.roll(
                        [data.number_of_rolls_remaining.toString() + "d6"],
                        { themeColor: "#F24405" },
                        {
                            a: data.roll_seed * 10000,
                            b: data.roll_seed * 20000,
                            c: data.roll_seed * 30000,
                            d: data.roll_seed * 40000
                        },
                        16
                    );
                    document.getElementById('submitTextButton').style.display='none';
                    console.log("Made it after the roll");
                }
            }

            function updateConnectedPlayers(data) {
                // `data.player_data` is an object: { player_id: {...}, player_id_2: {...}, ... }
                if (!data.player_data) return;
                const connectedPlayers = Object.keys(data.player_data);
                const listEl = document.getElementById('connectedPlayers');
                listEl.innerHTML = '';
                connectedPlayers.forEach(pid => {
                    const li = document.createElement('li');
                    li.textContent = pid;
                    listEl.appendChild(li);
                });
            }

            /////////////////////////////////////////////////////
            // Game Speed Radio: Show 10 or 6 text boxes
            /////////////////////////////////////////////////////
            const gameSpeedRadios = document.getElementsByName('gameSpeed');
            const defaultStory = document.getElementById('defaultStoryButton');
            const textBoxSection = document.getElementById('textBoxSection');

            function renderTextBoxes(count) {
                // Clear existing boxes
                textBoxSection.innerHTML = '';
                // Append new boxes
                const input = document.createElement('input');
                    input.id = "GameSummary";
                    input.type = 'text';
                    input.placeholder = "Write a story background here";
                    input.style.display = 'block';
                    input.style.marginBottom = '0.5em';
                    textBoxSection.appendChild(input);
                for (let i = 1; i <= count; i++) {
                    const input = document.createElement('input');
                    input.id = "Prompt"+i;
                    input.type = 'text';
                    input.placeholder = `Text #${i}`;
                    input.style.display = 'block';
                    input.style.marginBottom = '0.5em';
                    textBoxSection.appendChild(input);
                }
            }

            // Default to 9 on page load
            renderTextBoxes(9);

            // Listen for changes in Game Speed
            gameSpeedRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    if (radio.value === 'normal') {
                        renderTextBoxes(9);
                    } else {
                        renderTextBoxes(5);
                    }
                });
            });

        </script>

        <!-- Double-including these scripts is fine if you have them in your pipeline already -->
        <script src="assets/js/jquery.min.js"></script>
        <script src="assets/js/main.js"></script>
    </body>
</html>
